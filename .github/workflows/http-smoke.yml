name: HTTP Smoke Tests

on:
  # push:
  #   #branches: [ latest ]
  #   branches: [ pipelines ]
  pull_request:
    #branches: [ latest ]
    branches: [ pipelines ]

jobs:
  http-smoke:
    name: HTTP Smoke Tests (jediný port 33001)
    runs-on: ubuntu-latest

    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Start Docker Compose stack
        run: docker compose -f docker-compose.hk2025.yml up -d --build

      - name: Wait for frontend + sub systems
        run: sleep 30
      - name: Check running containers
        run: docker ps -a
      - name: Verify HTTP 200 on all service URLs
        run: |
          set -e
          echo "Ověřuji přístupnost jednotlivých URL (HTTP 200)…"
          SERVICES=(
            "index"
            "ug"
            "lessons"
            "projects"
            "events"
            "surveys"
            "facilities"
            "granting"
            "forms"
            "publications"
            "users"
          )
          for S in "${SERVICES[@]}"; do
            URL="http://localhost:33001/${S}/"
            echo -n "  → GET ${URL}… "
            # -f = fail 4xx/5xx response, -I = HEAD request
            if curl -s -f -I "$URL" >/dev/null; then
              echo "OK"
            else
              echo "CHYBA (není dostupné: ${URL})"
              exit 1
            fi
          done

      - name: Tear down Docker Compose stack
        if: always()
        run: |
          echo "Clean up…"
          docker compose -f docker-compose.hk2025.yml down --volumes
